<link rel="import" href="common-styles.html">

<link rel="import" href="login-view.html">
<link rel="import" href="register-view.html">
<link rel="import" href="loading-view.html">

<dom-module id="app-view">

  <template>

    <style include="common-styles"></style>
    
    <paper-drawer-panel>

      <div drawer class="layout vertical scrollable">
        <paper-item>Today</paper-item>
      </div>

      <div main>
        <paper-header-panel class="flex">
          <paper-toolbar>
              <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                  <div class="title">{{getTitle(breadcrumbs)}}</div>
              <paper-icon-button icon="more-vert" on-tap="moreAction"></paper-icon-button>
          </paper-toolbar>

          <iron-pages selected="{{selectedPageIndex}}">
            <loading-view></loading-view>
            <login-view on-login-success="onLoginSuccess"></login-view>
            <register-view></register-view>
            <today-view on-exerciseselected="onShowExercise"></today-view>
            <exercise-view exercise="{{currentExercise}}"
              on-exercise-saved="onExerciseSaved"></exercise-view>
          </iron-pages>
        </paper-header-panel>
      </div>

      </paper-drawer-panel>

      <iron-ajax
        id="loggedInService"
        url="http://localhost:5000/isloggedin"
        handle-as="json"
        content-type="application/json"
        method="GET"
        on-response="onIsLoggedInResponse"
        on-error="onIsLoggedInError"
        debounce-duration="300"></iron-ajax>

  </template>

  <script>

    Polymer({
      is: "app-view",

      behaviors: [
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {
        selectedPageIndex: {
          type: Number,
          value: 0
        },

        breadcrumbs: {
          type: Array,
          value: ['Starting Strength']
        },

        currentExercise: {
          type: Object,
          value: null
        }
      },

      getTitle: function(breadcrumbs)
      {
        return breadcrumbs.join(" > ")
      },

      onIsLoggedInResponse: function(event)
      {
        console.log("onLoginResponse, event:", event);
        this.navigateIfExercise();
      },

      onIsLoggedInError: function(event)
      {
        console.error("onIsLoggedInError, error:", event.detail);
        window.history.pushState(null, 'login', 'Login');
        this.selectedPageIndex = 1;
      },

      onLoginSuccess: function()
      {
        this.navigateIfExercise();
      },

      onShowExercise: function(event, exercise)
      {
        console.log("app-view::onShowExercise, exercise:", exercise);
        this.currentExercise = _.cloneDeep(exercise);
        if(exercise)
        {
          window.history.pushState({exercise: exercise}, exercise.name, '#' + exercise.name.toLowerCase());
          this.selectedPageIndex = 4;
        }
        else
        {
          window.history.pushState(null, '');
          this.selectedPageIndex = 3;
        }
        // var list = _.toArray(this.breadcrumbs);
        // list.push(exercise.name);
        // this.breadcrumbs = list;
        
      },

      navigateIfExercise: function(state)
      {
        console.log("app-view::navigateIfExercise, state:", state);
        if(state)
        {
          this.onShowExercise(null, state.exercise);
        }
        else
        {
          this.onShowExercise(null, null);
        }
      },

      attached: function()
      {
        console.log("app-view::attached");
        console.log("history.state:", history.state);
        this.navigateIfExercise(history.state);
        var me = this;
        window.onpopstate = function(event)
        {
          console.log("onpopstate:", event);
          me.navigateIfExercise(history.state);
        };

        this.testIsLoggedIn();
      },

      onExerciseSaved: function(event, exercise)
      {
        console.log("app-view::onExerciseSaved, exercise:", exercise);
      },

      testIsLoggedIn: function()
      {
        console.log("window.sessionStorage.token:", window.sessionStorage.token);
        var loggedInService = this.$.loggedInService;
        var makeRequest = function()
        {
          console.log("before:", loggedInService.headers);
          if(window.sessionStorage.token)
          {
            loggedInService.headers = {"Authorization": "Bearer " + window.sessionStorage.token};
          }
          console.log("headers:", loggedInService.headers);
          loggedInService.generateRequest();
        };
        makeRequest();
      }


    });
  </script>

</dom-module>