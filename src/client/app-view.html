<link rel="import" href="common-styles.html">

<link rel="import" href="login-view.html">
<link rel="import" href="register-view.html">
<link rel="import" href="loading-view.html">
<link rel="import" href="services/service-locator.html">

<dom-module id="app-view">

<template>

	<style include="common-styles"></style>

	<paper-drawer-panel>

		<div drawer class="layout vertical scrollable">
			<paper-item>Today</paper-item>
		</div>

		<div main>
			<paper-header-panel class="flex">
				<paper-toolbar>
					<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
					<div class="title">Title</div>
					<paper-icon-button icon="more-vert" on-tap="moreAction"></paper-icon-button>
				</paper-toolbar>

				<iron-pages selected="{{selectedPageIndex}}">
					<loading-view></loading-view>
					<login-view on-login-success="onLoginSuccess"
						on-register="onRegister"></login-view>
					<register-view></register-view>
					<today-view workout="{{currentWorkout}}" on-exerciseselected="onShowExercise"></today-view>
					<exercise-view id="exerciseView" exercise="{{currentExercise}}"
					on-save-exercise="onSaveExercise"></exercise-view>
				</iron-pages>
			</paper-header-panel>
		</div>

	</paper-drawer-panel>

<service-locator id="serviceLocator"></service-locator>


</template>

<script>

	Polymer({
		is: "app-view",

		behaviors: [
			Polymer.NeonAnimationRunnerBehavior
		],

		properties: {
			selectedPageIndex: {
				type: Number,
				value: 0
			},

			breadcrumbs: {
				type: Array,
				value: ['Starting Strength']
			},

			currentExercise: {
				type: Object,
				value: null
			},

			currentWorkout: {
				type: Object,
				value: null
			}
		},

		onShowExercise: function(event, exercise)
		{
			console.log("app-view::onShowExercise, exercise:", exercise);
			this.currentExercise = _.cloneDeep(exercise);
			if(exercise)
			{
				page('/today/exercise');
			}
			else
			{
				page('/today');
			}
		},

		navigateIfExercise: function(state)
		{
			console.log("app-view::navigateIfExercise, state:", state);
			if(state)
			{
				this.onShowExercise(null, state.exercise);
			}
			else
			{
				this.onShowExercise(null, null);
			}
		},

		attached: function()
		{
			var me = this;
			window.addEventListener('WebComponentsReady', function()
			{
				page.base('/#');

				page('/', function()
				{
					console.log("*** page /, index 0");
					page.redirect('/today');
				});
				page('/login', function()
				{
					console.log("*** page /login, index 1");
					me.selectedPageIndex = 1;
				});
				page('/register', function()
				{
					console.log("*** page /register, index 2");
					me.selectedPageIndex = 2;
				});
				page('/today', function()
				{
					console.log("*** page /today, index 3");
					me.selectedPageIndex = 3;
				});
				page('/today/exercise', function()
				{
					console.log("*** page /today/exercise, index 4");
					me.selectedPageIndex = 4;
				});
				page();
			});

			var serviceLocator = this.$.serviceLocator;
			serviceLocator.getService('loggedInService').loggedIn().then(function(success)
			{
				return serviceLocator.getService('workoutTodayService').getWorkoutToday();
			})
			.then(function(workout)
			{
				console.log("workout:", workout);
				me.currentWorkout = workout;	
			})
			.catch(function(error)
			{
				page('/login');
			});
		},

		onLoginSuccess: function()
		{
			console.log("app-view::onLoginSuccess");
			var me = this;
			this.$.serviceLocator.getService('workoutTodayService').getWorkoutToday()
			.then(function(workout)
			{
				console.log("workout:", workout);
				me.currentWorkout = workout;
				page('/today');
			})
			.catch(function(error)
			{
				console.log("no workout for you, you ain't logged in.");
				page('/login');
			});
		},

		onRegister: function()
		{
			page('/register');
		},

		onSaveExercise: function()
		{
			console.log("app-view::onSaveExercise");
			var me = this;
			var serviceLocator = me.$.serviceLocator;
			serviceLocator.getService('saveWorkoutService').saveWorkout(me.currentWorkout, me.currentExercise)
			.then(function(workout)
			{
				console.log("app-view::onSaveExercise, save successful, setting workout and redirecting back to today.");
				me.currentWorkout = workout;
				me.currentExercise = null;
				page('/today');
			})
			.catch(function(error)
			{
				console.error("app-view::onSaveExercise, save failed:", error);
				// page('/today');
			});
		}


});
</script>

</dom-module>