<dom-module id="jxl-calendar">

<style>

	:host {
		display: block;
		width: 330px;
		height: 400px;
		text-align: center;
	}

	.headerBackground
	{
		background-color: #2196F3;
		border-top-left-radius: 2px;
		border-top-right-radius: 2px;
	}

	.weekdayItem.weekdayItemButton
	{
		padding: 0px;
	}

	.weekdayItem.weekdayItemButton.previousButton
	{
		margin-left: 0px;
	}
	
	.weekdayItem.weekdayItemButton.nextButton
	{
		margin-right: 0px;
	}

	.weekdayItem
	{
		font-size: 0.9em;
		min-width: 40px;
		max-width: 40px;
		margin: 1px 2px;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		line-height: 40px;
		opacity: 0.54;
	}

	.dayItem
	{
		font-size: 0.9em;
		min-width: 40px;
		width: 40px;
		height: 40px;
		border-radius: 50%;
		margin: 1px 2px;
		cursor: pointer;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none; /* IE10+ */
		user-select: none;
		line-height: 20px;
	}

	.dayPaperButton
	{
		background: white;
		color: black;
	}

	.dayActive
	{
		opacity: 1;
	}

	.dayIsToday
	{
		color: #FF1744;
		background-color: #EEEEEE;
	}

	.dayIsSelected
	{
		color: #FFFFFF;
		background-color: #FF8A80;
	}

	.dayFade
	{
		opacity: 0.54;
	}

	.calendarBackground
	{
		background-color: #FFFFFF;
		margin-left: 0px;
		margin-right: 10px;
	}

	.dayHide
	{
		visibility: "hidden";
	}

</style>

<template>

	<style include="common-styles"></style>

	<div class="layout vertical calendarBackground">
		<div class="layout horizontal">
			<span class="flex weekdayItem">S</span>
			<span class="flex weekdayItem">M</span>
			<span class="flex weekdayItem">T</span>
			<span class="flex weekdayItem">W</span>
			<span class="flex weekdayItem">T</span>
			<span class="flex weekdayItem">F</span>
			<span class="flex weekdayItem">S</span>
		</div>
		<div id="daysContent" class="layout vertical">
			<div class="layout horizontal">
				<paper-button id="date0" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date1" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date2" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date3" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date4" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date5" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date6" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
			</div>
			<div class="layout horizontal">
				<paper-button id="date7" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date8" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date9" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date10" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date11" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date12" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date13" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
			</div>
			<div class="layout horizontal">
				<paper-button id="date14" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date15" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date16" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date17" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date18" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date19" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date20" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
			</div>
			<div class="layout horizontal">
				<paper-button id="date21" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date22" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date23" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date24" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date25" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date26" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date27" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
			</div>
			<div class="layout horizontal">
				<paper-button id="date28" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date29" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date30" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date31" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date32" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date33" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date34" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
			</div>
			<div class="layout horizontal">
				<paper-button id="date35" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date36" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date37" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date38" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date39" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date40" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
				<paper-button id="date41" class="dayItem dayPaperButton" on-tap="onSelectDay"></paper-button>
			</div>
		</div>
	</div>

</template>

<script>
	Polymer({

		is: "jxl-calendar",

		behaviors: [
		Polymer.NeonAnimationRunnerBehavior
		],

		properties: {

			today: {
				type: Date,
				value: function(){return moment()},
				observer: "_todayChanged"
			},

			currentDate: {
				type: Date,
				value: function(){return moment()},
				observer: "_currentDateChanged",
				notify: true
			},

			selectedDate: {
				type: Date,
				value: function(){return null;},
				observer: "_selectedDateChanged",
				notify: true
			}
		},

		animationConfig: {
			value: function()
			{
				return {
					'entry': [
					{
						name: 'fade-in-animation',
						node: this,
						timing: {duration: 1000}
					}
					],
					'exit': [
					{
						name: 'fade-out-animation',
						node: this,
						timing: {duration: 1000}
					}
					],
				};
			}
		},

		listeners: {
			// this event is fired when the animation finishes
			'neon-animation-finish': '_onNeonAnimationFinish'
		},

		hasAttached: false,

		attached: function()
		{
			this.hasAttached = true;
			this.redraw();
		},

		_onNeonAnimationFinish: function()
		{
			console.log("_onNeonAnimationFinish");
		},

		_validDate: function(obj)
		{
			return moment.isMoment(obj);
		},

		_todayChanged: function(newValue, oldValue)
		{
			console.log("jxl-calendar::_todayChanged");
			if(this._validDate(newValue))
			{
				this.redraw();
			}
		},

		_currentDateChanged: function(newValue, oldValue)
		{
			console.log("jxl-calendar::_currentDateChanged");
			if(this._validDate(newValue))
			{
				this.redraw();
			}
		},

		_selectedDateChanged: function(newValue, oldValue)
		{
			var me = this;
			if(me._validDate(newValue) && me.hasAttached)
			{
				debugger;
				for(var i = 0; i<42; i++)
				{
					var datePaperButton = me.$["date" + i];
					if(datePaperButton.classList.contains('dayIsSelected'))
					{
						me.toggleClass("dayIsSelected", false, datePaperButton);
					}
					if(datePaperButton.classList.contains('dayHide') === false)
					{
						var buttonsDate = moment(datePaperButton.getAttribute("dateString"));
						if(me.isDateSame(buttonsDate, me.selectedDate, 'day'))
						{
							me.toggleClass('dayIsSelected', true, datePaperButton);
						}
					}
				}
			}
		},

		redraw: function()
		{
			console.log("jxl-calendar::redraw");
			var me = this;
			if(me.hasAttached === false)
			{
				return;
			}

			if(_.every([me.today, me.currentDate], function(item) { return me._validDate(item);}) === false)
			{
				return;
			}

			var datePaperButton;
			for(var i = 0; i<42; i++)
			{
				datePaperButton = me.$["date" + i];
				me.toggleClass("dayHide", true, datePaperButton);
				datePaperButton.removeAttribute("dateString");
			}

			var days = [];
			var start = me.currentDate.clone().startOf('month').day(0);
			var end = me.currentDate.clone().endOf('month').day(6);
			var index = -1;
			var isCurrentDate, isSelected, isToday;
			moment()
			.range(start, end)
			.by('days', function(moment)
			{
				index++;
				datePaperButton = me.$["date" + index];
				datePaperButton.setAttribute("dateString", moment.toISOString());

				isCurrentDate = moment.isSame(me.currentDate, 'month') ? 'dayActive': 'dayFade';
				me.toggleClass(isCurrentDate, false, datePaperButton);

				isSelected = me.isDateSame(moment, me.selectedDate, 'day');
				me.toggleClass('dayIsSelected', isSelected, datePaperButton);

				isToday = moment.isSame(me.today, 'day');
				me.toggleClass("dayIsToday", isToday, datePaperButton);
				Polymer.dom(datePaperButton).textContent = moment.format('D');
			});
		   	// me.distributeContent();
		   },

		   notDefined: function(obj)
		   {
		   	return _.isNull(obj) || _.isUndefined(obj);
		   },

		// [jwarden 9.15.2015] moment is fine with null, but not with undefined apparently
		isDateSame: function(dateA, dateB, precision)
		{
			if(this.notDefined(dateA) || this.notDefined(dateB))
			{
				return false;
			}
			if(_.isString(precision) === false)
			{
				return dateA.isSame(dateB);
			}
			else
			{
				return dateA.isSame(dateB, precision);
			}
		},

		onSelectDay: function(event)
		{
			var clickedButton = event.detail.sourceEvent.target.parentElement;
			var dateString    = clickedButton.dataset.datestring;
			this.selectedDate = moment(dateString);
		}

	});

</script>

</dom-module>