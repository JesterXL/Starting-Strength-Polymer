<dom-module id="jxl-calendar">

	<style>

	:host {
		display: block;
		width: 330px;
		height: 400px;
		text-align: center;
	}

	.headerBackground
	{
		background-color: #2196F3;
		border-top-left-radius: 2px;
		border-top-right-radius: 2px;
	}

	.weekdayItem.weekdayItemButton
	{
		padding: 0px;
	}

	.weekdayItem.weekdayItemButton.previousButton
	{
		margin-left: 0px;
	}
	
	.weekdayItem.weekdayItemButton.nextButton
	{
		margin-right: 0px;
	}

	.weekdayItem
	{
		font-size: 0.9em;
		min-width: 40px;
		max-width: 40px;
		margin: 1px 2px;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		line-height: 40px;
		opacity: 0.54;
	}

	.dayItem
	{
		font-size: 0.9em;
		min-width: 40px;
		width: 40px;
		height: 40px;
		border-radius: 50%;
		margin: 1px 2px;
		cursor: pointer;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none; /* IE10+ */
		user-select: none;
		line-height: 20px;
	}

	.dayPaperButton
	{
	    background: white;
	    color: black;
	}

	.dayActive
	{
		opacity: 1;
	}

	.dayIsToday
	{
		color: #FF1744;
		background-color: #EEEEEE;
	}

	.dayIsSelected
	{
		color: #FFFFFF;
		background-color: #FF8A80;
	}

	.dayFade
	{
		opacity: 0.54;
	}

	.calendarBackground
	{
		background-color: #FFFFFF;
		margin-left: 0px;
		margin-right: 10px;
	}

	</style>

	<template>

		<style include="common-styles"></style>

		<div class="layout vertical calendarBackground">
			<div class="layout horizontal">
				<span class="flex weekdayItem">S</span>
				<span class="flex weekdayItem">M</span>
				<span class="flex weekdayItem">T</span>
				<span class="flex weekdayItem">W</span>
				<span class="flex weekdayItem">T</span>
				<span class="flex weekdayItem">F</span>
				<span class="flex weekdayItem">S</span>
			</div>
			<!-- <div class="layout horizontal wrap">
				<template is="dom-repeat" items="{{getDays(currentDate)}}">
					<paper-button class$="{{getDayButtonClass(item)}}" 
						data-datestring$="{{item.dateString}}"
						on-tap="onSelectDay">{{item.label}}</paper-button>
				</template>
			</div> -->
			<div id="daysContent" class="layout vertical"></div>
		</div>

	</template>

	<script>
	Polymer({

		is: "jxl-calendar",

		behaviors: [
			Polymer.NeonAnimationRunnerBehavior
		],

		properties: {

			today: {
				type: Date,
				value: function(){return moment()},
				observer: "_todayChanged"
			},

			currentDate: {
				type: Date,
				value: function(){return moment()},
				observer: "_currentDateChanged",
				notify: true
			},

			selectedDate: {
				type: Date,
				value: function(){return null;},
				observer: "_selectedDateChanged",
				notify: true
			}
		},

		animationConfig: {
			value: function()
			{
				return {
					'entry': [
						{
							name: 'fade-in-animation',
							node: this,
							timing: {duration: 1000}
						}
					],
					'exit': [
						{
							name: 'fade-out-animation',
							node: this,
							timing: {duration: 1000}
						}
					],
				};
			}
		},

		listeners: {
			// this event is fired when the animation finishes
			'neon-animation-finish': '_onNeonAnimationFinish'
		},

		_dayButtons: [],


	  _onNeonAnimationFinish: function()
	  {
	  	console.log("_onNeonAnimationFinish");
	  },

	  _validDate: function(obj)
	  {
	  	// return _.isDate(obj) && obj.toString() !== 'Invalid Date';
	  	return _.isObject(obj) && moment.isMoment(obj);
	  },

		_todayChanged: function(newValue, oldValue)
		{
			if(this._validDate(newValue))
			{
				this.setDate(newValue);
			}
		},

		_currentDateChanged: function(newValue, oldValue)
		{
			// var me = this;
			// _.delay(function()
			// {
			// 	console.log("playing");
			// 	me.playAnimation('entry');
			// }, 2000);
			if(this._validDate(newValue))
			{
				this.setDate(newValue);
			}
		},

		_selectedDateChanged: function(newValue, oldValue)
		{
			if(this._validDate(newValue))
			{
				this.setDate(newValue);
			}
		},

		attached: function()
		{
			this._draw();
		},

		_draw: function()
		{
			console.log("jxl-calendar::_draw");
			var me = this;
			var ROWS = 6;
			var COLS = 7;
			var btn;
			var rowDiv;
			for(var r = 0; r<ROWS; r++)
			{
				rowDiv = document.createElement('div');
				Polymer.dom(rowDiv).setAttribute('class', 'layout horizontal');
				Polymer.dom.flush();
				Polymer.dom(me.$.daysContent).appendChild(rowDiv);
				Polymer.dom.flush();
				for(var c = 0; c<COLS; c++)
				{
					btn = document.createElement('paper-button');
					// btn.textContent = "r: " + r + ", c: " + c;
					btn.addEventListener("tap", me.onSelectDay);
					Polymer.dom(rowDiv).appendChild(btn);
					Polymer.dom.flush();
					me._dayButtons.push(btn);
				}
			}
			me.setDate(me.currentDate);
		},

		setDate: function(date)
		{
			console.log("jxl-calendar::setDate, date:", date);
			var me = this;
			if(me._dayButtons.length < 1)
			{
				return;
			}

			for(var i = 0; i<42; i++)
			{
				me._dayButtons[i].style.visibility = "hidden";
			}
			
			var days = [];
			var start = me.currentDate.clone().startOf('month').day(0);
		   	var end = me.currentDate.clone().endOf('month').day(6);
		   	var index = -1;
		   	var isCurrentDate, isSelected, isToday;
		   	moment()
		   	.range(start, end)
		   	.by('days', function(moment)
		   	{
		   		index++;
		   		var btn = me._dayButtons[index];
		   		
		   		btn.dataset.dateString = moment.toISOString();
		   		isCurrentDate = moment.isSame(me.currentDate, 'month') ? 'dayActive': 'dayFade';
		   		isSelected = me.isDateSame(moment, me.selectedDate, 'day');
	   			isToday = moment.isSame(me.today, 'day');
	   			btn.style.visibility = "visible";
	   			// Polymer.dom(btn).setAttribute('class', me.getDayButtonClass(isCurrentDate, isSelected, isToday));
		   		_.forEach(me.getDayButtonClass(isCurrentDate, isSelected, isToday).split(" "), function(clazz)
		   		{
		   			me.toggleClass(clazz, true, btn);
		   		});
		   		Polymer.dom.flush();
		   		Polymer.dom(btn).textContent = moment.format('D');
		   		Polymer.dom.flush();
		   	});
		   	me.distributeContent();
		   	Polymer.dom.flush();
		},

		notDefined: function(obj)
		{
			return _.isNull(obj) || _.isUndefined(obj);
		},

		// [jwarden 9.15.2015] moment is fine with null, but not with undefined apparently
		isDateSame: function(dateA, dateB, precision)
		{
			if(this.notDefined(dateA) || this.notDefined(dateB))
			{
				return false;
			}
			if(_.isString(precision) === false)
			{
				return dateA.isSame(dateB);
			}
			else
			{
				return dateA.isSame(dateB, precision);
			}
		},

		getDayButtonClass: function(isCurrentDate, isSelected, isToday)
		{
			var str = "dayItem dayPaperButton " + isCurrentDate;
			if(isSelected)
			{
				str += " dayIsSelected";
			}
			else if(isToday)
			{
				str += " dayIsToday";
			}
			return str;
		},

		onSelectDay: function(event)
		{
			var clickedButton = event.detail.sourceEvent.target.parentElement;
			var dateString    = clickedButton.dataset.datestring;
			this.selectedDate = moment(dateString);
			this.currentDate  = this.currentDate.clone();
		}

	});

	</script>

</dom-module>