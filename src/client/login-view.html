<link rel="import" href="common-styles.html">

<dom-module id="login-view">

  <style>

  :host{
    position: relative;
    display: inline-block;
    padding: 12px;
  }

  #registerButton {
    color: #FF8A80;
  }

  </style>
  
  <template>
    
    <style include="common-styles"></style>

    <h1>Login</h1>

      <div class="layout vertical">
        <form is="iron-form">
          <paper-input id="username" label="Username"></paper-input>
          <paper-input id="password" type="password" label="Password" password></paper-input>
        </form>
      </div>
      <div>&nbsp;</div>
      <div class="layout horizontal bottom">
        <div class="layout vertical">
         <div class="flex"></div>
          <a href="#" id="registerButton">Need to register?</a>
          <div class="flex"></div>
        </div>
        <div class="flex"></div>
        <paper-button id="deleteButton">Delete Token</paper-button>
        <paper-button id="testIsLoggedIn">Test IsLoggedIn</paper-button>
        <paper-button id="loginButton">Login</paper-button>
      </div>
      
    <iron-ajax
      id="loginService"
      url="http://localhost:5000/login"
      handle-as="json"
      content-type="application/json"
      method="POST"
      on-response="loginResponse"
      debounce-duration="300"></iron-ajax>

 <iron-ajax
        id="loggedInService"
        url="http://localhost:5000/isloggedin"
        handle-as="json"
        content-type="application/json"
        method="GET"
        on-request="onLoginRequest"
        on-response="onLoginResponse"
        debounce-duration="300"></iron-ajax>

  </template>

  <script>

    Polymer({
      is: "login-view",

      behaviors: [
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {

      },

      listeners: {
        'loginButton.tap': 'onLogin',
        'registerButton.tap': 'onRegister',
        'deleteButton.tap': 'onDeleteToken',
        'testIsLoggedIn.tap': 'testIsLoggedIn'
      },

      onRegister: function()
      {
        this.fire("register");
      },

      onLogin: function()
      {
        console.log("login-view::login, this.$.username.value:", this.$.username.value);
        this.$.loginService.body = JSON.stringify({username: this.$.username.value, password: this.$.password.value});
        this.$.loginService.generateRequest();
      },

      loginResponse: function(response)
      {
        console.log("login-view::loginResponse, response:", response.detail.response);
        delete window.sessionStorage.token;
        var response = response.detail.response;
        if(response.result === true)
        {
          window.sessionStorage.token = response.token;
          this.fire('login-success');
        }
        else
        {
          this.fire('login-failure');
        }
      },

      onDeleteToken: function()
      {
        delete window.sessionStorage.token;
      },

      testIsLoggedIn: function()
      {
        console.log("window.sessionStorage.token:", window.sessionStorage.token);
        var loggedInService = this.$.loggedInService;
        var makeRequest = function()
        {
          console.log("before:", loggedInService.headers);
          if(window.sessionStorage.token)
          {
            loggedInService.headers = {"Authorization": "Bearer " + window.sessionStorage.token};
          }
          console.log("headers:", loggedInService.headers);
          loggedInService.generateRequest();
        };
        makeRequest();
      },

      onLoginRequest: function()
      {
        console.log("login-view::onLoginRequest:", arguments);
      },

      onLoginResponse: function()
      {
        console.log("login-view::onLoginResponse:", arguments);
      }

    });
  </script>

</dom-module>